<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Userscript Proxy Loader</title>
<style>
  :root { --bg:#0f1012; --panel:#131417; --muted:#9aa0a6; --accent:#0ea5a4; color-scheme: dark; }
  body{ margin:0; font-family: Inter, system-ui, sans-serif; background:var(--bg); color:#e6eef3; height:100vh; display:flex; flex-direction:column; }
  header{ display:flex; gap:.5rem; padding:.6rem; background:linear-gradient(180deg,#101214,#0b0b0c); align-items:center; border-bottom:1px solid #222;}
  input[type=text]{ background:transparent; color:inherit; border:1px solid #222; padding:.5rem; border-radius:6px; min-width:300px;}
  button{ padding:.5rem .7rem; background:var(--accent); border:none; color:#042424; border-radius:6px; cursor:pointer;}
  button.ghost{ background:transparent; border:1px solid #222; color:var(--muted);}
  main{ display:flex; flex:1; min-height:0; }
  #left{ width:360px; border-right:1px solid #202225; padding:12px; box-sizing:border-box; overflow:auto; background:var(--panel);}
  #right{ flex:1; min-height:0; display:flex; flex-direction:column; }
  .card{ background:#0b0b0b; border:1px solid #1a1a1b; padding:8px; border-radius:8px; margin-bottom:8px; }
  #scriptsList{ display:flex; flex-direction:column; gap:8px; margin-top:8px;}
  .script-row{ display:flex; gap:8px; align-items:center; }
  .script-row button { padding:.3rem .5rem; border-radius:6px; }
  .script-code{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; max-height:160px; overflow:auto; white-space:pre; background:#050505; padding:8px; border-radius:6px; border:1px dashed #222;}
  #iframeWrap{ flex:1; position:relative; background:#000; }
  iframe{ width:100%; height:100%; border:none; display:block; }
  footer{ padding:8px; text-align:center; font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<header>
  <input id="targetUrl" type="text" placeholder="Enter target URL (e.g. https://drednot.io)" value="https://drednot.io">
  <button id="openBtn">Open (via proxy)</button>
  <button id="openDirect" class="ghost">Open Direct (new tab)</button>
  <div style="flex:1"></div>
  <button id="saveState" class="ghost">Save local</button>
  <button id="loadState" class="ghost">Load local</button>
</header>

<main>
  <section id="left">
    <div class="card">
      <strong>Userscript Manager</strong>
      <div style="margin-top:8px;">
        <input id="scriptName" type="text" placeholder="Script name" style="width:100%; margin-bottom:6px;">
        <textarea id="scriptCode" placeholder="// paste userscript JS here" style="width:100%; height:160px; background:#050505; color:#dfe; border-radius:6px; padding:8px;"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="addScript">Add / Update</button>
          <button id="clearScripts" class="ghost">Clear all</button>
        </div>
      </div>
    </div>

    <div class="card">
      <strong>Installed scripts</strong>
      <div id="scriptsList"></div>
    </div>

    <div class="card">
      <strong>Proxy info</strong>
      <p style="color:var(--muted); font-size:13px">
        This UI expects a proxy endpoint that takes a `url` query param and returns the proxied page under the same origin.
        Use a Cloudflare Worker or Node proxy. Do not proxy sites without permission.
      </p>
      <label style="display:flex; gap:6px; align-items:center;">
        Proxy base URL
        <input id="proxyBase" type="text" value="https://YOUR-PROXY.workers.dev/fetch?url=" style="width:100%; margin-left:8px;">
      </label>
    </div>
  </section>

  <section id="right">
    <div style="padding:8px; border-bottom:1px solid #131316; background:#070708;">
      <strong>Preview</strong>
      <span style="color:var(--muted); margin-left:8px; font-size:13px">You can enable/disable scripts and they will be injected into the proxied page (same-origin)</span>
    </div>
    <div id="iframeWrap">
      <iframe id="targetFrame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </section>
</main>

<footer>
  <small>Userscript loader • Host UI on GitHub Pages • Proxy required (Cloudflare Worker recommended)</small>
</footer>

<script>
/* =========================
   Client side script manager
   ========================= */
const scriptsKey = 'userscript_loader_scripts_v1';
let scripts = JSON.parse(localStorage.getItem(scriptsKey) || '[]');
const targetFrame = document.getElementById('targetFrame');

function saveLocal() {
  localStorage.setItem(scriptsKey, JSON.stringify(scripts));
  alert('Saved locally');
}
function loadLocal() {
  scripts = JSON.parse(localStorage.getItem(scriptsKey) || '[]');
  renderScripts();
  alert('Loaded from localStorage');
}

document.getElementById('saveState').onclick = saveLocal;
document.getElementById('loadState').onclick = loadLocal;

function renderScripts() {
  const list = document.getElementById('scriptsList');
  list.innerHTML = '';
  scripts.forEach((s, i) => {
    const row = document.createElement('div');
    row.className = 'script-row';
    const name = document.createElement('div'); name.textContent = s.name; name.style.flex='1';
    const toggle = document.createElement('button'); toggle.textContent = s.enabled ? 'ON' : 'OFF';
    toggle.style.background = s.enabled ? '#2b8' : '#333';
    toggle.onclick = () => { s.enabled = !s.enabled; renderScripts(); };
    const edit = document.createElement('button'); edit.textContent = 'Edit'; edit.onclick = () => {
      document.getElementById('scriptName').value = s.name;
      document.getElementById('scriptCode').value = s.code;
    };
    const del = document.createElement('button'); del.textContent = 'Delete'; del.onclick = () => {
      if(confirm('Delete script?')) { scripts.splice(i,1); renderScripts(); }
    };
    row.appendChild(name);
    row.appendChild(toggle);
    row.appendChild(edit);
    row.appendChild(del);
    list.appendChild(row);

    const codeBlock = document.createElement('pre');
    codeBlock.className = 'script-code';
    codeBlock.textContent = s.code.slice(0, 800);
    list.appendChild(codeBlock);
  });
}

document.getElementById('addScript').onclick = () => {
  const name = document.getElementById('scriptName').value.trim();
  const code = document.getElementById('scriptCode').value;
  if(!name || !code) { alert('Provide name and code'); return; }
  // update if name exists
  const idx = scripts.findIndex(x=>x.name===name);
  if(idx>=0) scripts[idx] = { name, code, enabled: true };
  else scripts.push({ name, code, enabled: true });
  document.getElementById('scriptName').value = '';
  document.getElementById('scriptCode').value = '';
  renderScripts();
};

document.getElementById('clearScripts').onclick = () => { if(confirm('Clear all scripts?')) { scripts = []; renderScripts(); } };

renderScripts();

/* ===============
   Load / inject
   =============== */
function buildInjectedScript() {
  // Wrap all enabled scripts into one injection snippet that runs inside the proxied page
  const enabled = scripts.filter(s=>s.enabled);
  let out = `(function(){\n  // Combined injected userscripts (in proxied page context)\n  try {\n`;
  enabled.forEach((s, idx) => {
    out += `  // --- script: ${s.name}\n  (function(){\n${s.code.replace(/<\/script>/g,'<\\/script>')}\n  })();\n`;
  });
  out += `\n  } catch(e){ console.error('Injected userscript error', e); }\n})();`;
  return out;
}

async function openProxied() {
  const proxyBase = document.getElementById('proxyBase').value.trim();
  const url = document.getElementById('targetUrl').value.trim();
  if(!proxyBase) { alert('Set proxy base URL'); return; }
  if(!url) { alert('Set target URL'); return; }

  // Build the proxied URL. We encode the target as query param
  const proxied = proxyBase + encodeURIComponent(url);

  // Load proxied page in iframe
  targetFrame.src = proxied;

  // When iframe loads, inject scripts
  targetFrame.onload = async () => {
    try {
      // inject a script tag into the proxied page
      const script = targetFrame.contentDocument.createElement('script');
      script.type = 'text/javascript';
      script.text = buildInjectedScript();
      targetFrame.contentDocument.documentElement.appendChild(script);
      console.log('Injected userscripts into proxied frame.');
    } catch (err) {
      console.error('Injection failed (likely CORS or not same-origin):', err);
      alert('Injection failed. Make sure the proxy returns the page on the same origin as your UI (and that the proxy preserves cookies if needed).');
    }
  };
}

document.getElementById('openBtn').onclick = openProxied;
document.getElementById('openDirect').onclick = () => { window.open(document.getElementById('targetUrl').value, '_blank'); };

</script>
</body>
</html>
